{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{% trans 'Nueva Cotización' %}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header text-white" style="background-color:#1a3764;">
                    <h4 class="mb-0">{% trans 'Nueva Cotización' %}</h4>
                </div>
                <div class="card-body">
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        {% include 'snippets/messages.html' %}
                        <!-- DEPURACIÓN: Mostrar todos los errores internos del formulario y formset -->
                        {% if form.errors %}
                            <div class="alert alert-warning">
                                <strong>Errores del formulario principal (debug):</strong>
                                <pre>{{ form.errors.as_json }}</pre>
                            </div>
                        {% endif %}
                        {% if formset.errors %}
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle me-2"></i>Por favor, llena todos los items antes de guardar la cotización.
                            </div>
                        {% endif %}
                        {% if formset.non_form_errors %}
                            <div class="alert alert-warning">
                                <strong>Errores generales del formset (debug):</strong>
                                <pre>{{ formset.non_form_errors }}</pre>
                            </div>
                        {% endif %}
                        
                        <!-- Mostrar errores generales del formulario principal -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                <strong>Errores en el formulario principal:</strong>
                                <ul class="mb-0">
                                    {% for error in form.non_field_errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                        
                        <!-- Información Básica -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Información Básica</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.cotizacion.id_for_label }}" class="form-label">Cotización</label>
                                        {{ form.cotizacion|add_class:"form-control" }}
                                        {% if form.cotizacion.errors %}
                                            <div class="text-danger small mt-1">{{ form.cotizacion.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.tipo_cotizacion.id_for_label }}" class="form-label">Tipo de Cotización</label>
                                        {{ form.tipo_cotizacion|add_class:"form-control" }}
                                        {% if form.tipo_cotizacion.errors %}
                                            <div class="text-danger small mt-1">{{ form.tipo_cotizacion.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.estado.id_for_label }}" class="form-label">Estado</label>
                                        {{ form.estado|add_class:"form-control" }}
                                        {% if form.estado.errors %}
                                            <div class="text-danger small mt-1">{{ form.estado.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.fecha_cotizacion.id_for_label }}" class="form-label">Fecha de Cotización</label>
                                        {{ form.fecha_cotizacion }}
                                        {% if form.fecha_cotizacion.errors %}
                                            <div class="text-danger small mt-1">{{ form.fecha_cotizacion.errors.0 }}</div>
                                        {% endif %}
                                        <div style="font-size: 1rem; font-weight: 400; color: #333;">Fecha actual guardada: {{ form.fields.fecha_cotizacion.initial }}</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.validez_cotizacion.id_for_label }}" class="form-label">Validez de Cotización</label>
                                        {{ form.validez_cotizacion|add_class:"form-control" }}
                                        {% if form.validez_cotizacion.errors %}
                                            <div class="text-danger small mt-1">{{ form.validez_cotizacion.errors.0 }}</div>
                                        {% endif %}
                                        <div style="font-size: 1rem; font-weight: 400; color: #333;">Fecha actual guardada: {{ form.fields.validez_cotizacion.initial }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Información del Cliente -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">{% trans 'Información del Cliente' %}</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.dirigido_a.id_for_label }}" class="form-label">{% trans 'Dirigido a' %}</label>
                                        {{ form.dirigido_a|add_class:"form-control" }}
                                        {% if form.dirigido_a.errors %}
                                            <div class="text-danger small mt-1">{{ form.dirigido_a.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.empresa.id_for_label }}" class="form-label">{% trans 'Empresa' %}</label>
                                        {{ form.empresa|add_class:"form-control" }}
                                        {% if form.empresa.errors %}
                                            <div class="text-danger small mt-1">{{ form.empresa.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.ruc.id_for_label }}" class="form-label">{% trans 'RUC' %}</label>
                                        {{ form.ruc|add_class:"form-control" }}
                                        {% if form.ruc.errors %}
                                            <div class="text-danger small mt-1">{{ form.ruc.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Información del Servicio -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">{% trans 'Información del Servicio' %}</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="{{ form.servicio.id_for_label }}" class="form-label">{% trans 'Servicio' %}</label>
                                        {{ form.servicio|add_class:"form-control" }}
                                        {% if form.servicio.errors %}
                                            <div class="text-danger small mt-1">{{ form.servicio.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.modalidad.id_for_label }}" class="form-label">{% trans 'Modalidad' %}</label>
                                        {{ form.modalidad|add_class:"form-control" }}
                                        {% if form.modalidad.errors %}
                                            <div class="text-danger small mt-1">{{ form.modalidad.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.sede_servicio.id_for_label }}" class="form-label">{% trans 'Sede de Servicio' %}</label>
                                        {{ form.sede_servicio|add_class:"form-control" }}
                                        {% if form.sede_servicio.errors %}
                                            <div class="text-danger small mt-1">{{ form.sede_servicio.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="{{ form.fecha_servicio.id_for_label }}" class="form-label">{% trans 'Fecha de Servicio' %}</label>
                                        {{ form.fecha_servicio }}
                                        {% if form.fecha_servicio.errors %}
                                            <div class="text-danger small mt-1">{{ form.fecha_servicio.errors.0 }}</div>
                                        {% endif %}
                                        <div style="font-size: 1rem; font-weight: 400; color: #333;">Fecha actual guardada: {{ form.fields.fecha_servicio.initial }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modalidad de Pago -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">{% trans 'Modalidad de Pago' %}</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.tiempo_entrega.id_for_label }}" class="form-label">{% trans 'Tiempo de Entrega' %}</label>
                                        {{ form.tiempo_entrega|add_class:"form-control" }}
                                        {% if form.tiempo_entrega.errors %}
                                            <div class="text-danger small mt-1">{{ form.tiempo_entrega.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.modalidad_pago.id_for_label }}" class="form-label">{% trans 'Modalidad de Pago' %}</label>
                                        {{ form.modalidad_pago|add_class:"form-control" }}
                                        {{ form.modalidad_pago.errors }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Porcentajes de Pago -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">{% trans 'Porcentajes de Pago' %}</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ form.monto_cancelado.id_for_label }}" class="form-label">{% trans 'Monto Cancelado' %}</label>
                                        {{ form.monto_cancelado|add_class:"form-control" }}
                                        {% if form.monto_cancelado.errors %}
                                            <div class="text-danger small mt-1">{{ form.monto_cancelado.errors.0 }}</div>
                                        {% endif %}
                                        <div class="form-text">Ingresa el monto que ya ha sido pagado</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h6 class="card-title">{% trans 'Resumen de Pagos' %}</h6>
                                                <div class="row">
                                                    <div class="col-6">
                                                        <small class="text-muted">{% trans 'Porcentaje Cancelado:' %}</small>
                                                        <div class="fw-bold text-success" id="porcentaje-cancelado">0%</div>
                                                    </div>
                                                    <div class="col-6">
                                                        <small class="text-muted">{% trans 'Monto Pendiente:' %}</small>
                                                        <div class="fw-bold text-warning" id="monto-pendiente">S/ 0.00</div>
                                                    </div>
                                                </div>
                                                <div class="row mt-2">
                                                    <div class="col-6">
                                                        <small class="text-muted">{% trans 'Porcentaje Pendiente:' %}</small>
                                                        <div class="fw-bold text-danger" id="porcentaje-pendiente">100%</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Items de la Cotización -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">{% trans 'Items' %}</h5>
                            </div>
                            <div class="card-body">
                                {% if formset.errors %}
                                    <div class="alert alert-danger">
                                        <i class="fas fa-exclamation-circle me-2"></i>Faltan datos. Por favor, revisa los campos obligatorios.
                                    </div>
                                {% endif %}
                                {{ formset.management_form }}
                                <div id="items-container">
                                    {% for form in formset.forms %}
                                    <div class="item-form mb-3 p-3 border rounded bg-white shadow-sm" data-form-index="{{ forloop.counter0 }}">
                                        <div class="row g-2 align-items-end">
                                            <div class="col-12 mb-2">
                                                <span class="badge" style="font-size:1rem; background-color:#1a3764; color:#fff;">Ítem {{ forloop.counter }}</span>
                                            </div>
                                            <div class="col-12 col-md-3 mb-2">
                                                <label for="{{ form.curso.id_for_label }}" class="form-label fw-bold">Curso</label>
                                                {{ form.curso|add_class:"form-control" }}
                                                {{ form.curso.errors }}
                                            </div>
                                            <div class="col-6 col-md-2 mb-2">
                                                <label for="{{ form.duracion.id_for_label }}" class="form-label fw-bold">Duración</label>
                                                {{ form.duracion|add_class:"form-control" }}
                                                {{ form.duracion.errors }}
                                            </div>
                                            <div class="col-12 col-md-3 mb-2">
                                                <label for="{{ form.descripcion.id_for_label }}" class="form-label fw-bold">Descripción</label>
                                                {{ form.descripcion|add_class:"form-control" }}
                                                {{ form.descripcion.errors }}
                                            </div>
                                            <div class="col-6 col-md-1 mb-2">
                                                <label for="{{ form.cantidad.id_for_label }}" class="form-label fw-bold">Cant.</label>
                                                {{ form.cantidad|add_class:"form-control cantidad"|attr:"type:number"|attr:"min:1"|attr:"step:1" }}
                                                {{ form.cantidad.errors }}
                                            </div>
                                            <div class="col-6 col-md-2 mb-2">
                                                <label for="{{ form.precio_unitario.id_for_label }}" class="form-label fw-bold">Precio Unitario</label>
                                                {{ form.precio_unitario|add_class:"form-control precio"|attr:"type:number"|attr:"min:0"|attr:"step:0.01" }}
                                                {{ form.precio_unitario.errors }}
                                            </div>
                                            <div class="col-6 col-md-1 mb-2 d-flex flex-column align-items-end justify-content-end">
                                                <label class="form-label fw-bold">Subtotal</label>
                                                <div class="subtotal text-end mb-2" style="padding: 0.375rem 0.75rem; min-width: 70px;">0.00</div>
                                            </div>
                                        </div>
                                        {{ form.id }}
                                        {{ form.DELETE }}
                                    </div>
                                    <!-- Mostrar errores de cada ítem -->
                                    {% if form.non_field_errors %}
                                        <div class="alert alert-danger">
                                            <strong>Error en ítem {{ forloop.counter }}:</strong>
                                            <ul class="mb-0">
                                                {% for error in form.non_field_errors %}
                                                    <li>{{ error }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                <div class="row mt-4">
                                    <div class="col-md-12 text-end">
                                        <h4 class="mb-0">Total: <span id="total-amount" class="text-primary">S/ 0.00</span></h4>
                                        <h5 class="mb-0">Total + IGV (18%): <span id="total-igv" class="text-success">S/ 0.00</span></h5>
                                        <h6 class="mb-0">12% Detracción - Banco de la Nación: <span id="detraccion" class="text-warning">S/ 0.00</span></h6>
                                        <h5 class="mb-0 text-success fw-bold">INVERSIÓN TOTAL A DEPOSITAR: <span id="total-final" class="text-success">S/ 0.00</span></h5>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{% url 'cotizaciones_list' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> {% trans 'Volver' %}
                            </a>
                            <button type="submit" class="btn btn-gpd">
                                <i class="fas fa-save"></i> {% trans 'Guardar Cotización' %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Función para actualizar los cálculos de subtotales y total
    function actualizarCalculos() {
        let total = 0;
        document.querySelectorAll('.item-form').forEach(function(itemForm) {
            const deleteInput = itemForm.querySelector('input[name$="-DELETE"]');
            if (deleteInput && ((deleteInput.type === "checkbox" && deleteInput.checked) || (deleteInput.type !== "checkbox" && deleteInput.value === "on"))) return;
            const cantidad = itemForm.querySelector('.cantidad');
            const precio = itemForm.querySelector('.precio');
            const subtotalDiv = itemForm.querySelector('.subtotal');
            if (!cantidad || !precio || !subtotalDiv) return;
            const cantidadVal = parseFloat(cantidad.value) || 0;
            const precioVal = parseFloat(precio.value) || 0;
            const subtotal = cantidadVal * precioVal;
            subtotalDiv.textContent = subtotal.toFixed(2);
            total += subtotal;
        });
        const totalElement = document.getElementById('total-amount');
        const totalIgvElement = document.getElementById('total-igv');
        const detraccionElement = document.getElementById('detraccion');
        const totalFinalElement = document.getElementById('total-final');
        
        if (totalElement) totalElement.textContent = 'S/ ' + total.toFixed(2);
        
        const totalConIgv = total * 1.18;
        if (totalIgvElement) totalIgvElement.textContent = 'S/ ' + totalConIgv.toFixed(2);
        
        // Calcular detracción (12% si total + IGV >= 700)
        const detraccion = totalConIgv >= 700 ? totalConIgv * 0.12 : 0;
        if (detraccionElement) detraccionElement.textContent = 'S/ ' + detraccion.toFixed(2);
        
        // Calcular total final
        const totalFinal = totalConIgv + detraccion;
        if (totalFinalElement) totalFinalElement.textContent = 'S/ ' + totalFinal.toFixed(2);
    }

    // Función para actualizar el contador TOTAL_FORMS
    function actualizarTotalForms() {
        const forms = Array.from(document.querySelectorAll('.item-form')).filter(f => f.style.display !== 'none');
        const totalForms = document.getElementById('id_items-TOTAL_FORMS');
        if (totalForms) {
            totalForms.value = forms.length;
            console.log('TOTAL_FORMS actualizado:', totalForms.value);
        }
    }

    // Función para actualizar la visibilidad de los botones de eliminar
    function actualizarBotonesEliminar() {
        const visibles = Array.from(document.querySelectorAll('.item-form')).filter(f => f.style.display !== 'none');
        visibles.forEach(function(itemForm) {
            const btnEliminar = itemForm.querySelector('.btn-eliminar-item');
            if (btnEliminar) {
                btnEliminar.style.display = visibles.length <= 1 ? 'none' : '';
            }
        });
    }

    // Función para verificar si un item está vacío
    function esItemVacio(itemForm) {
        const curso = itemForm.querySelector('input[name$="-curso"]');
        const duracion = itemForm.querySelector('input[name$="-duracion"]');
        const descripcion = itemForm.querySelector('textarea[name$="-descripcion"]');
        const cantidad = itemForm.querySelector('.cantidad');
        const precio = itemForm.querySelector('.precio');
        
        return (
            (!curso.value || curso.value.trim() === '') &&
            (!duracion.value || duracion.value.trim() === '') &&
            (!descripcion.value || descripcion.value.trim() === '') &&
            (!cantidad.value || cantidad.value.trim() === '') &&
            (!precio.value || precio.value.trim() === '')
        );
    }

    // Función para validar un item
    function validarItem(itemForm) {
        const cantidad = itemForm.querySelector('.cantidad');
        const precio = itemForm.querySelector('.precio');
        let esValido = true;
        let mensajes = [];

        if (cantidad && cantidad.value) {
            const cantidadVal = parseInt(cantidad.value);
            if (cantidadVal <= 0) {
                mensajes.push('La cantidad debe ser mayor a 0');
                esValido = false;
            } else if (cantidadVal > 100) {
                mensajes.push('La cantidad no puede ser mayor a 100');
                esValido = false;
            }
        }

        if (precio && precio.value) {
            const precioVal = parseFloat(precio.value);
            if (precioVal <= 0) {
                mensajes.push('El precio unitario debe ser mayor a 0');
                esValido = false;
            }
        }

        return { esValido, mensajes };
    }

    // Función para marcar un item como eliminado
    function marcarComoEliminado(itemForm) {
        const deleteInput = itemForm.querySelector('input[name$="-DELETE"]');
        if (deleteInput) {
            if (deleteInput.type === "checkbox") {
                deleteInput.checked = true;
            } else {
                deleteInput.value = "on";
            }
        }
        itemForm.style.display = 'none';
    }

    // Función para agregar los event listeners a un item
    function agregarListeners(itemForm) {
        const cantidad = itemForm.querySelector('.cantidad');
        const precio = itemForm.querySelector('.precio');
        if (cantidad) cantidad.oninput = actualizarCalculos;
        if (precio) precio.oninput = actualizarCalculos;
        
        const btnEliminar = itemForm.querySelector('.btn-eliminar-item');
        if (btnEliminar) {
            btnEliminar.onclick = function() {
                const visibles = Array.from(document.querySelectorAll('.item-form')).filter(f => f.style.display !== 'none');
                if (visibles.length <= 1) {
                    alert('Debe haber al menos un ítem en la cotización.');
                    return;
                }
                marcarComoEliminado(itemForm);
                actualizarTotalForms();
                actualizarBotonesEliminar();
                actualizarCalculos();
            };
        }
    }

    // Manejar el envío del formulario
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Marcar como eliminados los items vacíos en vez de quitarlos del DOM
            let hayItemsValidos = false;
            let hayErrores = false;
            let mensajesError = [];

            document.querySelectorAll('.item-form').forEach(function(itemForm) {
                if (esItemVacio(itemForm)) {
                    marcarComoEliminado(itemForm);
                } else {
                    hayItemsValidos = true;
                    const { esValido, mensajes } = validarItem(itemForm);
                    if (!esValido) {
                        hayErrores = true;
                        mensajesError.push(...mensajes);
                    }
                }
            });
            
            // Actualizar el contador
            actualizarTotalForms();
            
            // Verificar si hay al menos un item
            if (!hayItemsValidos) {
                alert('Debe haber al menos un ítem en la cotización.');
                return false;
            }

            // Mostrar errores si los hay
            if (hayErrores) {
                alert('Por favor corrija los siguientes errores:\n' + mensajesError.join('\n'));
                return false;
            }
            
            // Si todo está bien, enviar el formulario
            this.submit();
        });
    }

    // Inicialización
    document.querySelectorAll('.item-form').forEach(agregarListeners);
    actualizarTotalForms();
    actualizarBotonesEliminar();
    actualizarCalculos();
    
    // Funcionalidad para porcentajes de pago
    function actualizarPorcentajesPago() {
        const montoCancelado = parseFloat(document.getElementById('{{ form.monto_cancelado.id_for_label }}').value) || 0;
        const totalFinal = parseFloat(document.getElementById('total-final').textContent.replace('S/ ', '')) || 0;
        
        if (totalFinal > 0) {
            const porcentajeCancelado = (montoCancelado / totalFinal) * 100;
            const montoPendiente = totalFinal - montoCancelado;
            const porcentajePendiente = 100 - porcentajeCancelado;
            
            document.getElementById('porcentaje-cancelado').textContent = porcentajeCancelado.toFixed(1) + '%';
            document.getElementById('monto-pendiente').textContent = 'S/ ' + montoPendiente.toFixed(2);
            document.getElementById('porcentaje-pendiente').textContent = porcentajePendiente.toFixed(1) + '%';
            
            // Cambiar colores según el porcentaje
            const porcentajeCanceladoElement = document.getElementById('porcentaje-cancelado');
            const porcentajePendienteElement = document.getElementById('porcentaje-pendiente');
            
            if (porcentajeCancelado >= 100) {
                porcentajeCanceladoElement.className = 'fw-bold text-success';
                porcentajePendienteElement.className = 'fw-bold text-success';
            } else if (porcentajeCancelado >= 50) {
                porcentajeCanceladoElement.className = 'fw-bold text-warning';
                porcentajePendienteElement.className = 'fw-bold text-warning';
            } else {
                porcentajeCanceladoElement.className = 'fw-bold text-danger';
                porcentajePendienteElement.className = 'fw-bold text-danger';
            }
        } else {
            document.getElementById('porcentaje-cancelado').textContent = '0%';
            document.getElementById('monto-pendiente').textContent = 'S/ 0.00';
            document.getElementById('porcentaje-pendiente').textContent = '100%';
        }
    }
    
    // Agregar event listener al campo monto_cancelado
    const montoCanceladoInput = document.getElementById('{{ form.monto_cancelado.id_for_label }}');
    if (montoCanceladoInput) {
        montoCanceladoInput.addEventListener('input', function() {
            actualizarPorcentajesPago();
        });
    }
    
    // Modificar la función actualizarCalculos para que también actualice los porcentajes
    const originalActualizarCalculos = actualizarCalculos;
    actualizarCalculos = function() {
        originalActualizarCalculos();
        actualizarPorcentajesPago();
    };
    
    // Inicializar porcentajes
});
</script>
{% endblock %} 