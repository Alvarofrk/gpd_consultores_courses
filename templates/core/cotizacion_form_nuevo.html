{% extends 'base.html' %}
{% load i18n %}
{% load widget_tweaks %}

{% block title %}Nueva Cotización (Nuevo){% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Nueva Cotización (Nuevo)</h4>
                </div>
                <div class="card-body">
                    {# Mostrar errores generales y de campos del formulario principal #}
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}
                    {% for field in form %}
                        {% for error in field.errors %}
                            <div class="alert alert-danger">
                                <strong>{{ field.label }}:</strong> {{ error }}
                            </div>
                        {% endfor %}
                    {% endfor %}
                    {# Mostrar errores generales y de campos del formset de ítems #}
                    {% if formset.non_form_errors %}
                        <div class="alert alert-danger">
                            {{ formset.non_form_errors }}
                        </div>
                    {% endif %}
                    {% for form_item in formset.forms %}
                        {% for field in form_item %}
                            {% for error in field.errors %}
                                <div class="alert alert-danger">
                                    <strong>Item - {{ field.label }}:</strong> {{ error|striptags }}
                                </div>
                            {% endfor %}
                        {% endfor %}
                    {% endfor %}
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <!-- Información Básica -->
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label" for="{{ form.nombre_anio.id_for_label }}">Nombre del Año</label>
                                {{ form.nombre_anio|add_class:"form-control" }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label" for="{{ form.cotizacion.id_for_label }}">Cotización</label>
                                {{ form.cotizacion|add_class:"form-control" }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label" for="{{ form.tipo_cotizacion.id_for_label }}">Tipo de Cotización</label>
                                {{ form.tipo_cotizacion|add_class:"form-control" }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label" for="{{ form.estado.id_for_label }}">Estado</label>
                                {{ form.estado|add_class:"form-control" }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label" for="{{ form.fecha_cotizacion.id_for_label }}">Fecha de Cotización</label>
                                {{ form.fecha_cotizacion|add_class:"form-control" }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label" for="{{ form.validez_cotizacion.id_for_label }}">Validez de Cotización</label>
                                {{ form.validez_cotizacion|add_class:"form-control" }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label" for="{{ form.modalidad_pago.id_for_label }}">Modalidad de Pago</label>
                                {{ form.modalidad_pago|add_class:"form-control" }}
                            </div>
                        </div>
                        <!-- Información del Cliente -->
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label" for="{{ form.dirigido_a.id_for_label }}">Dirigido a</label>
                                {{ form.dirigido_a|add_class:"form-control" }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label" for="{{ form.empresa.id_for_label }}">Empresa</label>
                                {{ form.empresa|add_class:"form-control" }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label" for="{{ form.ruc.id_for_label }}">RUC</label>
                                {{ form.ruc|add_class:"form-control" }}
                            </div>
                        </div>
                        <!-- Información del Servicio -->
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label" for="{{ form.servicio.id_for_label }}">Servicio</label>
                                {{ form.servicio|add_class:"form-control" }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label" for="{{ form.modalidad.id_for_label }}">Modalidad</label>
                                {{ form.modalidad|add_class:"form-control" }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label" for="{{ form.sede_servicio.id_for_label }}">Sede de Servicio</label>
                                {{ form.sede_servicio|add_class:"form-control" }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label" for="{{ form.fecha_servicio.id_for_label }}">Fecha de Servicio</label>
                                {{ form.fecha_servicio|add_class:"form-control" }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label" for="{{ form.tiempo_entrega.id_for_label }}">Tiempo de Entrega</label>
                                {{ form.tiempo_entrega|add_class:"form-control" }}
                            </div>
                        </div>
                        <hr>
                        <!-- Items de la Cotización -->
                        <h5>Items de la Cotización</h5>
                        {{ formset.management_form }}
                        <div id="items-container">
                            {% for form in formset.forms %}
                            <div class="item-form mb-3 p-3 border rounded bg-white shadow-sm" data-form-index="{{ forloop.counter0 }}">
                                <div class="row align-items-end">
                                    <div class="col-md-2 mb-3">
                                        <label class="form-label" for="{{ form.curso.id_for_label }}">Curso</label>
                                        {{ form.curso|add_class:"form-control" }}
                                    </div>
                                    <div class="col-md-2 mb-3">
                                        <label class="form-label" for="{{ form.duracion.id_for_label }}">Duración</label>
                                        {{ form.duracion|add_class:"form-control" }}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label" for="{{ form.descripcion.id_for_label }}">Descripción</label>
                                        {{ form.descripcion|add_class:"form-control" }}
                                    </div>
                                    <div class="col-md-1 mb-3">
                                        <label class="form-label" for="{{ form.cantidad.id_for_label }}">Cant.</label>
                                        {{ form.cantidad|add_class:"form-control cantidad"|attr:"type:number"|attr:"min:1"|attr:"step:1" }}
                                    </div>
                                    <div class="col-md-2 mb-3">
                                        <label class="form-label" for="{{ form.precio_unitario.id_for_label }}">Precio Unitario</label>
                                        {{ form.precio_unitario|add_class:"form-control precio"|attr:"type:number"|attr:"min:0"|attr:"step:0.01" }}
                                    </div>
                                    <div class="col-md-2 mb-3">
                                        <div class="form-label fw-bold">Subtotal</div>
                                        <div class="subtotal text-end" style="padding: 0.375rem 0.75rem;">0.00</div>
                                    </div>
                                </div>
                                {{ form.id }}
                                <button type="button" class="btn btn-danger btn-sm btn-eliminar-item">Eliminar</button>
                                {{ form.DELETE }}
                            </div>
                            {% endfor %}
                        </div>
                        <!-- Bloque oculto para el empty_form -->
                        <div id="empty-form" style="display:none;">
                            <div class="item-form mb-3 p-3 border rounded bg-white shadow-sm" data-form-index="__prefix__">
                                <div class="row align-items-end">
                                    <div class="col-md-2 mb-3">
                                        <label class="form-label" for="{{ formset.empty_form.curso.id_for_label }}">Curso</label>
                                        {{ formset.empty_form.curso|add_class:"form-control" }}
                                    </div>
                                    <div class="col-md-2 mb-3">
                                        <label class="form-label" for="{{ formset.empty_form.duracion.id_for_label }}">Duración</label>
                                        {{ formset.empty_form.duracion|add_class:"form-control" }}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label" for="{{ formset.empty_form.descripcion.id_for_label }}">Descripción</label>
                                        {{ formset.empty_form.descripcion|add_class:"form-control" }}
                                    </div>
                                    <div class="col-md-1 mb-3">
                                        <label class="form-label" for="{{ formset.empty_form.cantidad.id_for_label }}">Cant.</label>
                                        {{ formset.empty_form.cantidad|add_class:"form-control cantidad"|attr:"type:number"|attr:"min:1"|attr:"step:1" }}
                                    </div>
                                    <div class="col-md-2 mb-3">
                                        <label class="form-label" for="{{ formset.empty_form.precio_unitario.id_for_label }}">Precio Unitario</label>
                                        {{ formset.empty_form.precio_unitario|add_class:"form-control precio"|attr:"type:number"|attr:"min:0"|attr:"step:0.01" }}
                                    </div>
                                    <div class="col-md-2 mb-3">
                                        <div class="form-label fw-bold">Subtotal</div>
                                        <div class="subtotal text-end" style="padding: 0.375rem 0.75rem;">0.00</div>
                                    </div>
                                </div>
                                {{ formset.empty_form.id }}
                                <button type="button" class="btn btn-danger btn-sm btn-eliminar-item">Eliminar</button>
                                {{ formset.empty_form.DELETE }}
                            </div>
                        </div>
                        <button type="button" class="btn btn-success btn-sm mt-2" id="btn-agregar-item">Agregar ítem</button>
                        <div class="row mt-4">
                            <div class="col-md-12 text-end">
                                <h4 class="mb-0">Total: <span id="total-amount" class="text-primary">S/ 0.00</span></h4>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'cotizaciones_list' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Volver
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar Cotización
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
input[name$="-DELETE"] {
    display: none;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    function actualizarCalculos() {
        let total = 0;
        document.querySelectorAll('.item-form').forEach(function(itemForm) {
            const deleteInput = itemForm.querySelector('input[name$="-DELETE"]');
            if (deleteInput && ((deleteInput.type === "checkbox" && deleteInput.checked) || (deleteInput.type !== "checkbox" && deleteInput.value === "on"))) return;
            const cantidad = itemForm.querySelector('.cantidad');
            const precio = itemForm.querySelector('.precio');
            const subtotalDiv = itemForm.querySelector('.subtotal');
            if (!cantidad || !precio || !subtotalDiv) return;
            const cantidadVal = parseFloat(cantidad.value) || 0;
            const precioVal = parseFloat(precio.value) || 0;
            const subtotal = cantidadVal * precioVal;
            subtotalDiv.textContent = subtotal.toFixed(2);
            total += subtotal;
        });
        const totalElement = document.getElementById('total-amount');
        if (totalElement) totalElement.textContent = 'S/ ' + total.toFixed(2);
    }

    function agregarListeners() {
        document.querySelectorAll('.item-form').forEach(function(itemForm) {
            const cantidad = itemForm.querySelector('.cantidad');
            const precio = itemForm.querySelector('.precio');
            if (cantidad) cantidad.oninput = actualizarCalculos;
            if (precio) precio.oninput = actualizarCalculos;
            // Botón eliminar
            const btnEliminar = itemForm.querySelector('.btn-eliminar-item');
            if (btnEliminar) {
                btnEliminar.onclick = function() {
                    // Contar ítems visibles (no eliminados ni ocultos)
                    const visibles = Array.from(document.querySelectorAll('.item-form'))
                        .filter(f => f.style.display !== 'none');
                    if (visibles.length <= 1) {
                        alert('Debe haber al menos un ítem en la cotización.');
                        return;
                    }
                    const deleteInput = itemForm.querySelector('input[name$="-DELETE"]');
                    const idInput = itemForm.querySelector('input[type="hidden"][name$="-id"]');
                    if (idInput && idInput.value) {
                        // Ítem existente: marcar para eliminar y ocultar visualmente
                        if (deleteInput) {
                            if (deleteInput.type === "checkbox") {
                                deleteInput.checked = true;
                            } else {
                                deleteInput.value = "on";
                            }
                        }
                        itemForm.style.display = 'none';
                    } else {
                        // Ítem nuevo: eliminar del DOM y actualizar TOTAL_FORMS
                        itemForm.remove();
                        const totalForms = document.getElementById('id_items-TOTAL_FORMS');
                        totalForms.value = document.querySelectorAll('.item-form').length;
                    }
                    actualizarCalculos();
                };
            }
        });
    }

    document.getElementById('btn-agregar-item').addEventListener('click', function() {
        const itemsContainer = document.getElementById('items-container');
        const totalForms = document.getElementById('id_items-TOTAL_FORMS');
        const currentCount = parseInt(totalForms.value);
        // Usa el empty-form como plantilla
        const emptyFormHtml = document.getElementById('empty-form').innerHTML.replace(/__prefix__/g, currentCount);
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = emptyFormHtml;
        const newForm = tempDiv.firstElementChild;
        itemsContainer.appendChild(newForm);
        totalForms.value = currentCount + 1;
        agregarListeners();
        actualizarCalculos();
    });

    agregarListeners();
    actualizarCalculos();

    // Antes de enviar, elimina ítems nuevos vacíos y actualiza TOTAL_FORMS
    document.querySelector('form').addEventListener('submit', function(e) {
        document.querySelectorAll('.item-form').forEach(function(itemForm) {
            const idInput = itemForm.querySelector('input[type="hidden"][name$="-id"]');
            const cantidad = itemForm.querySelector('.cantidad');
            const precio = itemForm.querySelector('.precio');
            // Si es un ítem nuevo y está vacío, elimínalo del DOM
            if ((!idInput || !idInput.value) &&
                (!cantidad.value || !precio.value)) {
                itemForm.remove();
            }
        });
        // Actualiza TOTAL_FORMS
        const totalForms = document.getElementById('id_items-TOTAL_FORMS');
        totalForms.value = document.querySelectorAll('.item-form').length;
    });
});
</script>
{% endblock %} 