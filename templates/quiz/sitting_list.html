{% extends 'base.html' %}
{% load i18n %}
{% block title %}{% trans "Todos los Cuestionarios" %} | {% trans 'Sistema de gestión de aprendizaje' %}{% endblock %}

{% block content %}

<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
	<ol class="breadcrumb">
		<li class="breadcrumb-item"><a href="/">{% trans 'Inicio' %}</a></li>
		<li class="breadcrumb-item active" aria-current="page">{% trans 'Exámenes Completos' %}</li>
	</ol>
</nav>

<!-- Header Principal -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #1a237e 0%, #3f51b5 100%);">
            <div class="card-body text-white p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="mb-2">
                            <i class="fas fa-check-double me-3"></i>
                            {% trans 'Exámenes Completos' %}
                        </h2>
                        <p class="mb-0 opacity-75">
                            {% trans "Gestión y seguimiento de evaluaciones finalizadas" %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard de Estadísticas -->
<div class="row mb-4">
    <div class="col-12">
        <div class="row g-3">
            <div class="col-lg-3 col-md-6">
                <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <div class="card-body text-white text-center p-3">
                        <i class="fas fa-graduation-cap fa-2x mb-2"></i>
                        <h4 class="mb-1">{{ total_exams }}</h4>
                        <p class="mb-0 small">{% trans "Total Exámenes" %}</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);">
                    <div class="card-body text-white text-center p-3">
                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                        <h4 class="mb-1">{{ total_approved }}</h4>
                        <p class="mb-0 small">{% trans "Aprobados" %}</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);">
                    <div class="card-body text-white text-center p-3">
                        <i class="fas fa-times-circle fa-2x mb-2"></i>
                        <h4 class="mb-1">{{ total_failed }}</h4>
                        <p class="mb-0 small">{% trans "No Aprobados" %}</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);">
                    <div class="card-body text-white text-center p-3">
                        <i class="fas fa-users fa-2x mb-2"></i>
                        <h4 class="mb-1">{{ object_list|length }}</h4>
                        <p class="mb-0 small">{% trans "Usuarios Únicos" %}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtros mejorados -->
<div class="card mb-4">
    <div class="card-body">
        <form action="" method="GET" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="user_filter" class="form-label">{% trans 'Usuario' %}</label>
                <input type="text" name="user_filter" id="user_filter" class="form-control" 
                       placeholder="{% trans 'Buscar por usuario' %}" value="{{ request.GET.user_filter }}">
            </div>
            <div class="col-md-4">
                <label for="quiz_filter" class="form-label">{% trans 'Cuestionario' %}</label>
                <input type="text" name="quiz_filter" id="quiz_filter" class="form-control" 
                       placeholder="{% trans 'Buscar por cuestionario' %}" value="{{ request.GET.quiz_filter }}">
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-search"></i> {% trans "Filtrar" %}
                </button>
                <a href="{% url 'quiz_marking' %}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> {% trans "Limpiar" %}
                </a>
            </div>
        </form>
    </div>
</div>

{% if object_list %}

	<!-- Información de estadísticas -->
	<div class="row mb-3">
		<div class="col-md-6">
			<div class="alert alert-info">
				<i class="fas fa-info-circle"></i>
				{% trans 'Total de exámenes completos' %}: <strong>{{ total_exams }}</strong>
			</div>
		</div>
		<div class="col-md-6">
			<div class="alert alert-success">
				<i class="fas fa-list"></i>
				{% trans 'Mostrando página' %} <strong>{{ current_page }}</strong> 
				{% if is_paginated %}de {{ page_obj.paginator.num_pages }}{% endif %}
			</div>
		</div>
	</div>

	<!-- Tabla de exámenes -->
	<div class="table-responsive">
		<table class="table table-bordered table-striped table-hover">
			<thead class="table-dark">
				<tr>
					<th>#</th>
					<th>{% trans "Usuario" %}</th>
					<th>{% trans "Curso" %}</th>
					<th>{% trans "Cuestionario" %}</th>
					<th>{% trans "Completado" %}</th>
					<th>{% trans "Intentos" %}</th>
					<th>{% trans "Puntuación" %}</th>
					<th>{% trans "Estado" %}</th>
					<th>{% trans "Acciones" %}</th>
				</tr>
			</thead>
			<tbody>
			{% for sitting in object_list %}
			<tr>
				<td>
					{% if is_paginated %}
						{{ page_obj.start_index|add:forloop.counter0 }}
					{% else %}
						{{ forloop.counter }}
					{% endif %}
				</td>
				<td>
					<strong>{{ sitting.user.username }}</strong><br>
					<small class="text-muted">{{ sitting.user.get_full_name }}</small>
				</td>
				<td>{{ sitting.quiz.course.title }}</td>
				<td>{{ sitting.quiz.title }}</td>
				<td>{{ sitting.end|date:"d/m/Y H:i" }}</td>
				<td>
					<span class="badge {% if sitting.total_attempts == 1 %}bg-success{% elif sitting.total_attempts <= 3 %}bg-warning{% else %}bg-danger{% endif %}" 
						  title="Total: {{ sitting.total_attempts }} | Aprobados: {{ sitting.approved_attempts }}">
						{{ sitting.total_attempts }}
					</span>
				</td>
				<td>
					<span class="badge {% if sitting.get_percent_correct >= 80 %}bg-success{% elif sitting.get_percent_correct >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
						{{ sitting.get_percent_correct }}%
					</span>
				</td>
				<td>
					{% if sitting.get_percent_correct >= sitting.quiz.pass_mark %}
						<span class="badge bg-success">{% trans "Aprobado" %}</span>
					{% else %}
						<span class="badge bg-danger">{% trans "No Aprobado" %}</span>
					{% endif %}
				</td>
				<td>
					<div class="btn-group" role="group">
						<a href="{% url 'quiz_marking_detail' pk=sitting.id %}" class="btn btn-sm btn-primary" title="{% trans 'Ver detalles del examen' %}">
							<i class="fas fa-eye"></i>
						</a>
						{% if sitting.get_percent_correct >= sitting.quiz.pass_mark %}
							<a href="{% url 'generar_certificado' sitting.id %}" class="btn btn-sm btn-success" title="{% trans 'Descargar certificado' %}">
								<i class="fas fa-download"></i>
							</a>
						{% endif %}
					</div>
				</td>
			</tr>
			{% endfor %}
			</tbody>
		</table>
	</div>

	<!-- Paginación -->
	{% if is_paginated %}
	<nav aria-label="Navegación de páginas">
		<ul class="pagination justify-content-center">
			{% if page_obj.has_previous %}
				<li class="page-item">
					<a class="page-link" href="?page=1{% if request.GET.user_filter %}&user_filter={{ request.GET.user_filter }}{% endif %}{% if request.GET.quiz_filter %}&quiz_filter={{ request.GET.quiz_filter }}{% endif %}">
						<i class="fas fa-angle-double-left"></i> {% trans "Primera" %}
					</a>
				</li>
				<li class="page-item">
					<a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.user_filter %}&user_filter={{ request.GET.user_filter }}{% endif %}{% if request.GET.quiz_filter %}&quiz_filter={{ request.GET.quiz_filter }}{% endif %}">
						<i class="fas fa-angle-left"></i> {% trans "Anterior" %}
					</a>
				</li>
			{% endif %}

			{% for num in page_obj.paginator.page_range %}
				{% if page_obj.number == num %}
					<li class="page-item active">
						<span class="page-link">{{ num }}</span>
					</li>
				{% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
					<li class="page-item">
						<a class="page-link" href="?page={{ num }}{% if request.GET.user_filter %}&user_filter={{ request.GET.user_filter }}{% endif %}{% if request.GET.quiz_filter %}&quiz_filter={{ request.GET.quiz_filter }}{% endif %}">{{ num }}</a>
					</li>
				{% endif %}
			{% endfor %}

			{% if page_obj.has_next %}
				<li class="page-item">
					<a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.user_filter %}&user_filter={{ request.GET.user_filter }}{% endif %}{% if request.GET.quiz_filter %}&quiz_filter={{ request.GET.quiz_filter }}{% endif %}">
						{% trans "Siguiente" %} <i class="fas fa-angle-right"></i>
					</a>
				</li>
				<li class="page-item">
					<a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.user_filter %}&user_filter={{ request.GET.user_filter }}{% endif %}{% if request.GET.quiz_filter %}&quiz_filter={{ request.GET.quiz_filter }}{% endif %}">
						{% trans "Última" %} <i class="fas fa-angle-double-right"></i>
					</a>
				</li>
			{% endif %}
		</ul>
	</nav>

	<!-- Información de paginación -->
	<div class="text-center mt-3">
		<p class="text-muted">
			{% trans "Mostrando" %} {{ page_obj.start_index }} - {{ page_obj.end_index }} 
			{% trans "de" %} {{ page_obj.paginator.count }} {% trans "exámenes" %}
		</p>
	</div>
	{% endif %}

{% else %}
	<div class="alert alert-warning text-center">
		<i class="fas fa-exclamation-triangle"></i>
		{% trans "No hay exámenes completos para mostrar." %}
</div>
{% endif %}

<!-- Estilos CSS Adicionales -->
<style>
    .card {
        transition: all 0.3s ease;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
    }
    
    .table {
        border-radius: 8px;
        overflow: hidden;
    }
    
    .table-dark {
        background: linear-gradient(135deg, #1a237e 0%, #3f51b5 100%) !important;
    }
    
    .badge {
        border-radius: 20px;
        font-size: 0.8em;
        padding: 0.5em 0.8em;
    }
    
    .btn-group .btn {
        border-radius: 6px;
        margin: 0 1px;
    }
    
    .btn-group .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(26, 35, 126, 0.05) !important;
        transform: scale(1.01);
        transition: all 0.2s ease;
    }
    
    .opacity-75 {
        opacity: 0.75;
    }
</style>

{% endblock %}