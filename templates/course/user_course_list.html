{% extends 'base.html' %}
{% load i18n %}
{% block title %} {% trans 'Mis Cursos' %} | {% trans 'Sistema de gestión de aprendizaje' %}{% endblock title %}
{% load static %}

{% block content %}

<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">{% trans 'Inicio' %}</a></li>
        <li class="breadcrumb-item active" aria-current="page">{% trans 'Mis Cursos' %}</li>
    </ol>
</nav>

{% if request.user.is_student %}
    <div class="title-1">{{ student.program.title }}</div>
    {% if student.program.summary %}
        <p>{{ student.program.summary }}</p>
    {% endif %}
{% endif %}

{% if request.user.is_lecturer %}
    <div class="title-1">{% trans 'Mis Cursos' %}</div>
{% endif %}

{% include 'snippets/messages.html' %}

{% if request.user.is_student %}
<!-- Dashboard de Estadísticas -->
<div class="row mb-4">
    <div class="col-lg-2 col-md-4 mb-3">
        <div class="card bg-primary text-white h-100">
            <div class="card-body text-center">
                <i class="fas fa-graduation-cap fa-2x mb-2"></i>
                <h3 class="mb-0">{{ total_courses }}</h3>
                <p class="mb-0">{% trans 'Total' %}</p>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 mb-3">
        <div class="card bg-success text-white h-100">
            <div class="card-body text-center">
                <i class="fas fa-trophy fa-2x mb-2"></i>
                <h3 class="mb-0">{{ completed_courses }}</h3>
                <p class="mb-0">{% trans 'Completados' %}</p>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 mb-3">
        <div class="card bg-warning text-white h-100">
            <div class="card-body text-center">
                <i class="fas fa-play-circle fa-2x mb-2"></i>
                <h3 class="mb-0">{{ in_progress_courses }}</h3>
                <p class="mb-0">{% trans 'En Progreso' %}</p>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 mb-3">
        <div class="card bg-danger text-white h-100">
            <div class="card-body text-center">
                <i class="fas fa-times-circle fa-2x mb-2"></i>
                <h3 class="mb-0">{{ exam_failed_courses }}</h3>
                <p class="mb-0">{% trans 'Examen Fallido' %}</p>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-0">{% trans 'Mis Cursos' %}</h5>
                        <small class="text-muted">{{ total_courses }} {% trans 'cursos registrados' %}</small>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="btn-group flex-wrap" role="group">
                            <button type="button" class="btn btn-outline-primary active" onclick="filterCourses('all')">
                                {% trans 'Todos' %} ({{ total_courses }})
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="filterCourses('course_completed')">
                                {% trans 'Completados' %} ({{ completed_courses }})
                            </button>
                            <button type="button" class="btn btn-outline-warning" onclick="filterCourses('material_in_progress')">
                                {% trans 'En Progreso' %} ({{ in_progress_courses }})
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="filterCourses('exam_failed')">
                                {% trans 'Examen Fallido' %} ({{ exam_failed_courses }})
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cards de Cursos -->
<div class="row" id="courses-container">
    {% for course_data in courses_with_progress %}
    <div class="col-lg-4 col-md-6 mb-4 course-card" data-status="{{ course_data.course_status }}">
        <div class="card h-100 shadow-sm course-card-item">
            <div class="card-header" style="background: linear-gradient(135deg, #1a237e 0%, #3f51b5 100%); color: white;">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-1">{{ course_data.course.title }}</h5>
                        <small class="text-light">{{ course_data.course.code }}</small>
                    </div>
                    <div class="text-end">
                        {% if course_data.course_status == 'course_completed' %}
                            <i class="fas fa-trophy text-success fa-lg"></i>
                        {% elif course_data.course_status == 'material_in_progress' %}
                            <i class="fas fa-play-circle text-warning fa-lg"></i>
                        {% elif course_data.course_status == 'exam_available' %}
                            <i class="fas fa-clipboard-list text-info fa-lg"></i>
                        {% elif course_data.course_status == 'exam_failed' %}
                            <i class="fas fa-times-circle text-danger fa-lg"></i>
                        {% else %}
                            <i class="fas fa-circle text-muted fa-lg"></i>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="card-body">
                <!-- Barra de Progreso del Material -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted">{% trans 'Progreso del Material' %}</small>
                        <small class="fw-bold">{{ course_data.material_progress }}%</small>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar 
                            {% if course_data.course_status == 'course_completed' %}bg-success
                            {% elif course_data.course_status == 'material_in_progress' %}bg-warning
                            {% elif course_data.course_status == 'exam_available' %}bg-info
                            {% elif course_data.course_status == 'exam_failed' %}bg-danger
                            {% else %}bg-secondary{% endif %}" 
                             style="width: {{ course_data.material_progress }}%">
                        </div>
                    </div>
                </div>
                
                <!-- Información del Contenido -->
                <div class="row text-center mb-3">
                    <div class="col-4">
                        <div class="d-flex flex-column align-items-center">
                            <i class="fas fa-play-circle text-primary fa-lg mb-1"></i>
                            <small class="fw-bold">{{ course_data.completion_summary.completed_videos }}/{{ course_data.content_summary.total_videos }}</small>
                            <small class="text-muted">{% trans 'Videos' %}</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="d-flex flex-column align-items-center">
                            <i class="fas fa-file-alt text-info fa-lg mb-1"></i>
                            <small class="fw-bold">{{ course_data.completion_summary.completed_documents }}/{{ course_data.content_summary.total_documents }}</small>
                            <small class="text-muted">{% trans 'Docs' %}</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="d-flex flex-column align-items-center">
                            <i class="fas fa-percentage text-success fa-lg mb-1"></i>
                            <small class="fw-bold">{{ course_data.completion_summary.completed_content }}/{{ course_data.content_summary.total_content }}</small>
                            <small class="text-muted">{% trans 'Total' %}</small>
                        </div>
                    </div>
                </div>
                
                <!-- Información del Examen -->
                {% if course_data.exam_info %}
                <div class="mb-3 p-2" style="background-color: #f8f9fa; border-radius: 8px;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="fw-bold text-dark">
                            <i class="fas fa-clipboard-list me-1"></i>{% trans 'Examen' %}
                        </small>
                        {% if course_data.exam_info.passed %}
                            <span class="badge bg-success">{% trans 'Aprobado' %}</span>
                        {% elif course_data.exam_info.attempted %}
                            <span class="badge bg-danger">{% trans 'Fallido' %}</span>
                        {% else %}
                            <span class="badge bg-info">{% trans 'Disponible' %}</span>
                        {% endif %}
                    </div>
                    {% if course_data.exam_info.attempted %}
                        <div class="row text-center">
                            <div class="col-6">
                                <small class="text-muted">{% trans 'Mejor Puntuación' %}</small>
                                <div class="fw-bold">{{ course_data.exam_info.best_score }}%</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">{% trans 'Nota Mínima' %}</small>
                                <div class="fw-bold">{{ course_data.exam_info.pass_mark }}%</div>
                            </div>
                        </div>
                        {% if course_data.exam_info.attempts > 1 %}
                            <div class="text-center mt-1">
                                <small class="text-muted">{% trans 'Intentos' %}: {{ course_data.exam_info.attempts }}</small>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center">
                            <small class="text-muted">{% trans 'Nota mínima para aprobar' %}: {{ course_data.exam_info.pass_mark }}%</small>
                        </div>
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- Estado del Curso -->
                <div class="text-center mb-3">
                    {% if course_data.course_status == 'course_completed' %}
                        <span class="badge bg-success fs-6">
                            <i class="fas fa-trophy me-1"></i>{% trans 'Curso Completado' %}
                        </span>
                    {% elif course_data.course_status == 'material_in_progress' %}
                        <span class="badge bg-warning fs-6">
                            <i class="fas fa-play me-1"></i>{% trans 'Material en Progreso' %}
                        </span>
                    {% elif course_data.course_status == 'exam_available' %}
                        <span class="badge bg-info fs-6">
                            <i class="fas fa-clipboard-list me-1"></i>{% trans 'Examen Disponible' %}
                        </span>
                    {% elif course_data.course_status == 'exam_failed' %}
                        <span class="badge bg-danger fs-6">
                            <i class="fas fa-times me-1"></i>{% trans 'Examen Fallido' %}
                        </span>
                    {% else %}
                        <span class="badge bg-secondary fs-6">
                            <i class="fas fa-circle me-1"></i>{% trans 'No Iniciado' %}
                        </span>
                    {% endif %}
                </div>
            </div>
            
            <div class="card-footer bg-transparent border-0">
                {% if course_data.course_status == 'course_completed' %}
                    <div class="d-grid gap-2">
                        <a href="{{ course_data.course.get_absolute_url }}" 
                           class="btn btn-success">
                            <i class="fas fa-eye me-2"></i>{% trans 'Ver Curso' %}
                        </a>
                    </div>
                {% elif course_data.course_status == 'material_in_progress' %}
                    <a href="{{ course_data.course.get_absolute_url }}" 
                       class="btn btn-warning w-100">
                        <i class="fas fa-play me-2"></i>{% trans 'Continuar Material' %}
                    </a>
                {% elif course_data.course_status == 'exam_available' %}
                    <div class="d-grid gap-2">
                        <a href="{% url 'quiz_index' course_data.course.slug %}" 
                           class="btn btn-info">
                            <i class="fas fa-clipboard-list me-2"></i>{% trans 'Tomar Examen' %}
                        </a>
                        <a href="{{ course_data.course.get_absolute_url }}" 
                           class="btn btn-outline-info btn-sm">
                            <i class="fas fa-eye me-1"></i>{% trans 'Revisar Material' %}
                        </a>
                    </div>
                {% elif course_data.course_status == 'exam_failed' %}
                    <div class="d-grid gap-2">
                        {% if course_data.exam_info.can_retake %}
                            <a href="{% url 'quiz_index' course_data.course.slug %}" 
                               class="btn btn-danger">
                                <i class="fas fa-redo me-2"></i>{% trans 'Reintentar Examen' %}
                            </a>
                        {% else %}
                            <button class="btn btn-secondary" disabled>
                                <i class="fas fa-ban me-2"></i>{% trans 'Sin Reintentos' %}
                            </button>
                        {% endif %}
                        <a href="{{ course_data.course.get_absolute_url }}" 
                           class="btn btn-outline-danger btn-sm">
                            <i class="fas fa-eye me-1"></i>{% trans 'Revisar Material' %}
                        </a>
                    </div>
                        {% else %}
                    <a href="{{ course_data.course.get_absolute_url }}" 
                       class="btn btn-primary w-100">
                        <i class="fas fa-play me-2"></i>{% trans 'Iniciar Curso' %}
                    </a>
                        {% endif %}
            </div>
    </div>
</div>
    {% endfor %}
</div>

<!-- Mensaje si no hay cursos -->
{% if not courses_with_progress %}
<div class="text-center py-5">
    <i class="fas fa-graduation-cap fa-3x text-muted mb-3"></i>
    <h4 class="text-muted">{% trans 'No tienes cursos registrados' %}</h4>
    <p class="text-muted">{% trans 'Contacta con tu administrador para registrarte en cursos.' %}</p>
</div>
{% endif %}
{% endif %}
 
{% if request.user.is_student %}
<div class="row mt-4">
    <div class="col-12 text-center">
        <a href="{% url 'download_courses_pdf' %}" class="btn btn-outline-primary btn-lg">
            <i class="fas fa-download me-2"></i>{% trans 'Descargar Consolidado PDF' %}
        </a>
    </div>
</div>
{% endif %}
{% if request.user.is_lecturer %}
    <div class="table-responsive p-3">
        <h6 class="fw-bold text-primary"><u>{% trans 'Cursos Disponibles:' %}</u></h6>
        <div class="table-shadow">
            <table class="table table-light">
                <thead>
                    <tr>
                        
                        <th> {% trans 'Nombre del Curso' %} </th>
                        <th> {% trans 'Código del Curso' %} </th>
                        <!-- <th> {% trans 'Créditos' %} </th>
                        <th> {% trans 'Año' %} </th>
                        <th> {% trans 'Grupo' %} </th> -->
                        <!-- <th> {% trans 'Grupo Actual' %} </th> -->
                    </tr>
                </thead>
                <tbody>
                    {% for course in courses %}
                    <tr>
                        
                        <td><a href="{{ course.get_absolute_url }}">
                            {{ course.title }}</a></td>
                        <td>{{ course.code }}</td>
                        <!-- <td>{{ course.credit }}</td>
                        <td>{{ course.year }}</td>
                        <td>{{ course.semester }}</td> -->
                        <!-- <th>
                            {% if course.is_current_semester == False %}
                            <i class="fas fa-times-circle fa-1-5x danger"></i>
                            {% else %}
                            <i class="fas fa-check-circle"></i>
                            {% endif %}
                        </th> -->
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endif %}

{% if courses.paginator.page_range|length > 1 %}
<div class="content-center">
    <div class="pagination">
        <a href="?page=1">&laquo;</a>
        {% for i in courses.paginator.page_range %}
            {% if i == courses.number %}
                <a class="pagination-active" href="?page={{ i }}"><b>{{ i }}</b></a>
            {% else %}
                <a href="?page={{ i }}">{{ i }}</a>
            {% endif %}
        {% endfor %}
        <a href="?page={{ courses.paginator.num_pages }}">&raquo;</a>
    </div>
</div>
{% endif %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Función para filtrar cursos
        window.filterCourses = function(status) {
            const courseCards = document.querySelectorAll('.course-card');
            const filterButtons = document.querySelectorAll('.btn-group .btn');
            
            // Actualizar botones activos
            filterButtons.forEach(btn => {
                btn.classList.remove('active');
                const btnText = btn.textContent.trim();
                if (status === 'all' && btnText.includes('Todos')) {
                    btn.classList.add('active');
                } else if (status === 'course_completed' && btnText.includes('Completados')) {
                    btn.classList.add('active');
                } else if (status === 'material_in_progress' && btnText.includes('En Progreso')) {
                    btn.classList.add('active');
                } else if (status === 'exam_failed' && btnText.includes('Examen Fallido')) {
                    btn.classList.add('active');
                }
            });
            
            // Mostrar/ocultar cards según el filtro
            courseCards.forEach(card => {
                if (status === 'all' || card.dataset.status === status) {
                    card.style.display = 'block';
                    card.style.animation = 'fadeIn 0.3s ease-in';
                } else {
                    card.style.display = 'none';
                }
            });
        };
        
        // Añadir animación CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .course-card-item {
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            }
            .course-card-item:hover {
                transform: translateY(-5px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
            }
        `;
        document.head.appendChild(style);
    });
</script>

{% endblock content %}
